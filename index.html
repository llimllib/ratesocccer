<!DOCTYPE html>
<html>
<meta charset="utf-8">
<head>
<title>European Team Ratings</title>
<link rel="stylesheet" href="http://billmill.org/css/960css/reset.css" />
<link rel="stylesheet" href="http://billmill.org/css/960css/960.css" />
<link rel="stylesheet" href="http://billmill.org/css/style.css" />
<style>
th {
  border-bottom: 2px solid #ddd;
  padding: 8px;
  font-weight: bold;
}
td {
  padding: 8px;
  border-top: 1px solid #ddd;
}
.spark, .sparktd {
  padding: 2px;
}
path {
    stroke: steelblue;
    stroke-width: 1;
    fill: none;
}
</style>
</head>
<body>
<div class="container_16">
    <div class="grid_3">
        <a href="http://billmill.org"><img src="http://billmill.org/images/logo.png" width="136" height="94"></a>
    </div>
    <div class="clear"></div>

    <div class="grid_13 prefix_3 content">

<h1>European Team Ratings</h1>

<div id="datatable"></div>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script>

// global var yes I know dude it's for debugging chill out
teams = []

d3.csv("ratingdata/allteams.csv", function(error, csv) {
  csv.forEach(function(row) {
    row.mu = parseFloat(row.mu).toFixed(1);
    row.sigma = parseFloat(row.sigma).toFixed(1);
    row.ninetyfive = row.mu - (2 * row.sigma);
    row.five = row.mu + (2 * row.sigma);
    row.change = d3.format("+.1f")(row.change)
    row.last5 = row.last5.split("|").map(Number)
    teams.push(row);
  });

  teams.sort(function(a,b) {
    if (a.mu < b.mu) return 1;
    if (a.mu > b.mu) return -1;
    return 0;
  });

  var maxMu = 0;
  var minMu = Number.MAX_VALUE;
  var max95 = 0;
  var min95 = Number.MAX_VALUE;
  for (i=0; i < teams.length; i++) {
    if (teams[i].mu > maxMu) { maxMu = teams[i].mu; }
    if (teams[i].mu < minMu) { minMu = teams[i].mu; }
    if (teams[i].five > max95) { max95 = teams[i].five; }
    if (teams[i].ninetyfive < min95) { min95 = teams[i].ninetyfive; }
  }

  var table = d3.select("#datatable").append("table");
      thead = table.append("thead");
      tbody = table.append("tbody");

  thead.append("th").text("Team");
  thead.append("th").html("League");
  thead.append("th").text("Other");
  thead.append("th").text("Rating");
  thead.append("th").text("Change");
  thead.append("th").text("Last 5");

  var tr = tbody.selectAll("tr")
      .data(teams)
      .enter().append("tr");

  var td = tr.selectAll("td")
        .data(function(d) { return [[d.sanitizedname, d.name], d.leaguerecord, d.otherrecord, d.mu, d.change]; })
      .enter().append("td")
        .html(function(d,i) {
            if (i==0) {
              return '<a href="history.html?t='+d[0]+'">'+d[1]+'</a>';
            } else {
              return d;
            }
        });

  var width = 49,
      height = 17;
  var x = d3.scale.linear().domain([0, 4]).range([0, width]);
  var y = d3.scale.linear().domain([minMu, maxMu]).range([height, 0]);

  function sety(last5) {
    var max = 0;
    var min = Number.MAX_VALUE;
    for (i=0; i < last5.length; i++) {
      if (last5[i] > max) max = last5[i];
      if (last5[i] < min) min = last5[i];
    }
    y = d3.scale.linear().domain([min, max]).range([height,0]);
    return last5;
  }

  var line = d3.svg.line()
    .x(function(d,i) { return x(i); })
    .y(function(d)   { return y(d); });

  tr.append("td")
      .attr("class", "sparktd")
    .append("svg")
      .attr("class", "spark")
      .attr("height", height)
      .attr("width", width)
    .append("svg:path")
      .attr("d", function(d) { return line(sety(d.last5)); });

});
</script>
</body>
</html>
